name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: '.git .github'

  test-ubuntu:
    name: Test on Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
    container:
      image: ubuntu:${{ matrix.ubuntu-version }}
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git jq

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test install.sh script
        run: |
          ./install.sh
          echo "✓ install.sh completed"

      - name: Verify installation
        run: |
          test -x ~/.local/bin/al-compile || exit 1
          echo "✓ Binary installed to ~/.local/bin/"

      - name: Test installed binary
        run: |
          ~/.local/bin/al-compile --version
          echo "✓ Installed binary works"

  test-fedora:
    name: Test on Fedora ${{ matrix.fedora-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fedora-version: ['38', '39', '40']
    container:
      image: fedora:${{ matrix.fedora-version }}
    steps:
      - name: Install dependencies
        run: |
          dnf install -y git jq

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test install.sh script
        run: |
          ./install.sh
          echo "✓ install.sh completed"

      - name: Verify installation
        run: |
          test -x ~/.local/bin/al-compile || exit 1
          echo "✓ Binary installed to ~/.local/bin/"

      - name: Test installed binary
        run: |
          ~/.local/bin/al-compile --version
          echo "✓ Installed binary works"

  test-debian:
    name: Test on Debian ${{ matrix.debian-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        debian-version: ['11', '12']
    container:
      image: debian:${{ matrix.debian-version }}
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y git jq

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test install.sh script
        run: |
          ./install.sh
          echo "✓ install.sh completed"

      - name: Verify installation
        run: |
          test -x ~/.local/bin/al-compile || exit 1
          echo "✓ Binary installed to ~/.local/bin/"

      - name: Test installed binary
        run: |
          ~/.local/bin/al-compile --version
          echo "✓ Installed binary works"

  test-arch:
    name: Test on Arch Linux
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm git jq

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test install.sh script
        run: |
          ./install.sh
          echo "✓ install.sh completed"

      - name: Verify installation
        run: |
          test -x ~/.local/bin/al-compile || exit 1
          echo "✓ Binary installed to ~/.local/bin/"

      - name: Test installed binary
        run: |
          ~/.local/bin/al-compile --version
          echo "✓ Installed binary works"

  test-error-handling:
    name: Test Error Handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Test without app.json (should fail gracefully)
        run: |
          cd /tmp
          if ~/work/al-smart-compile/al-smart-compile/al-compile 2>&1 | grep -q "app.json"; then
            echo "✓ Correctly detects missing app.json"
          else
            echo "✗ Failed to detect missing app.json"
            exit 1
          fi

      - name: Test invalid analyzer flag
        run: |
          cd /tmp
          if ~/work/al-smart-compile/al-smart-compile/al-compile --analyzers invalid 2>&1; then
            echo "✓ Handles invalid analyzer flag"
          else
            echo "✓ Script exits on invalid flag (expected behavior)"
          fi

  test-windows-bash:
    name: Test on Windows (Git Bash)
    runs-on: windows-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (via chocolatey)
        run: choco install jq -y
        shell: pwsh

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test platform detection (should detect windows)
        run: |
          ./al-compile --version 2>&1 | head -1
          echo "✓ Platform detection works"

      - name: Test without app.json (should fail gracefully)
        run: |
          mkdir -p /tmp/test-dir
          cd /tmp/test-dir
          if ! "$GITHUB_WORKSPACE/al-compile" 2>/dev/null; then
            echo "✓ Correctly exits with error when app.json missing"
          else
            echo "✗ Script should have failed without app.json"
            exit 1
          fi

  test-windows-powershell:
    name: Test on Windows (PowerShell)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test PowerShell script exists
        run: |
          if (Test-Path "al-compile.ps1") {
            Write-Host "✓ al-compile.ps1 exists"
          } else {
            Write-Host "✗ al-compile.ps1 not found"
            exit 1
          }

      - name: Test -Version flag
        run: |
          .\al-compile.ps1 -Version
          Write-Host "✓ -Version works"

      - name: Test -Help flag
        run: |
          .\al-compile.ps1 -Help
          Write-Host "✓ -Help works"

      - name: Test install.ps1 script
        run: |
          if (Test-Path "install.ps1") {
            Write-Host "✓ install.ps1 exists"
          } else {
            Write-Host "✗ install.ps1 not found"
            exit 1
          }

  test-macos:
    name: Test on macOS ${{ matrix.macos-version }}
    runs-on: ${{ matrix.macos-version }}
    strategy:
      matrix:
        macos-version: ['macos-13', 'macos-14']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq (via homebrew)
        run: brew list jq &>/dev/null || brew install jq

      - name: Test script is executable
        run: |
          test -x ./al-compile || exit 1
          echo "✓ Script is executable"

      - name: Test --version flag
        run: |
          ./al-compile --version
          echo "✓ --version works"

      - name: Test --help flag
        run: |
          ./al-compile --help
          echo "✓ --help works"

      - name: Test platform detection (should detect darwin)
        run: |
          if ./al-compile --help 2>&1 | head -1 | grep -q "al-compile"; then
            echo "✓ Script runs on macOS"
          else
            echo "✗ Script failed to run on macOS"
            exit 1
          fi

      - name: Test install.sh script
        run: |
          ./install.sh
          echo "✓ install.sh completed"

      - name: Verify installation
        run: |
          test -x ~/.local/bin/al-compile || exit 1
          echo "✓ Binary installed to ~/.local/bin/"

      - name: Test installed binary
        run: |
          ~/.local/bin/al-compile --version
          echo "✓ Installed binary works"

      - name: Test without app.json (should fail gracefully)
        run: |
          mkdir -p /tmp/test-dir
          cd /tmp/test-dir
          if ! "$GITHUB_WORKSPACE/al-compile" 2>/dev/null; then
            echo "✓ Correctly exits with error when app.json missing"
          else
            echo "✗ Script should have failed without app.json"
            exit 1
          fi
